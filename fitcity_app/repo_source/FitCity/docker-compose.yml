services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: fitcity-sqlserver
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "${MSSQL_SA_PASSWORD}"
    ports:
      - "1433:1433"
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P ${MSSQL_SA_PASSWORD} -C -d master -Q \"SELECT 1\""]
      interval: 10s
      timeout: 5s
      retries: 10

  rabbitmq:
    image: rabbitmq:3-management
    container_name: fitcity-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: "${RABBITMQ_USER}"
      RABBITMQ_DEFAULT_PASS: "${RABBITMQ_PASS}"
    ports:
      - "5672:5672"
      - "15672:15672"

  fitcity.api:
    build:
      context: ./src
      dockerfile: FitCity.Api/Dockerfile
    container_name: fitcity-api
    env_file:
      - .env
    environment:
      ASPNETCORE_ENVIRONMENT: "Development"
      ASPNETCORE_URLS: "http://+:8080"
      ConnectionStrings__DefaultConnection: "${DB_CONNECTION}"
      Jwt__Issuer: "${JWT_ISSUER}"
      Jwt__Audience: "${JWT_AUDIENCE}"
      Jwt__SecretKey: "${JWT_SECRET}"
      Jwt__ExpirationMinutes: "${JWT_EXPIRATION_MINUTES}"
      RabbitMq__HostName: "${RABBITMQ_HOST}"
      RabbitMq__Port: "${RABBITMQ_PORT}"
      RabbitMq__UserName: "${RABBITMQ_USER}"
      RabbitMq__Password: "${RABBITMQ_PASS}"
      RabbitMq__Exchange: "${RABBITMQ_EXCHANGE}"
      Email__Provider: "${EMAIL_PROVIDER}"
      Email__Host: "${EMAIL_HOST}"
      Email__Port: "${EMAIL_PORT}"
      Email__Username: "${EMAIL_USER}"
      Email__Password: "${EMAIL_PASS}"
      Email__From: "${EMAIL_FROM}"
      Email__FileOutputPath: "${EMAIL_FILE_OUTPUT_PATH}"
    ports:
      - "8081:8080"
    depends_on:
      sqlserver:
        condition: service_healthy
      rabbitmq:
        condition: service_started

  fitcity.notifications.worker:
    build:
      context: ./src
      dockerfile: FitCity.Notifications.Api/Dockerfile
    container_name: fitcity-notifications-worker
    env_file:
      - .env
    environment:
      ConnectionStrings__DefaultConnection: "${DB_CONNECTION}"
      RabbitMq__HostName: "${RABBITMQ_HOST}"
      RabbitMq__Port: "${RABBITMQ_PORT}"
      RabbitMq__UserName: "${RABBITMQ_USER}"
      RabbitMq__Password: "${RABBITMQ_PASS}"
      RabbitMq__Exchange: "${RABBITMQ_EXCHANGE}"
      Email__Host: "${EMAIL_HOST}"
      Email__Port: "${EMAIL_PORT}"
      Email__Username: "${EMAIL_USER}"
      Email__Password: "${EMAIL_PASS}"
      Email__From: "${EMAIL_FROM}"
      Email__DisplayName: "${EMAIL_DISPLAY_NAME}"
      Email__EnableSsl: "${EMAIL_ENABLE_SSL}"
      Email__TimeoutSeconds: "${EMAIL_TIMEOUT_SECONDS}"
    depends_on:
      sqlserver:
        condition: service_healthy
      rabbitmq:
        condition: service_started
